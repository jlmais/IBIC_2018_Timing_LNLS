\documentclass[a4paper,
               %boxit,        % check whether paper is inside correct margins
               %titlepage,    % separate title page
               %refpage       % separate references
               biblatex,      % biblatex is used
               %keeplastbox,  % flushend option: not to un-indent last line in References
               %nospread,     % flushend option: do not fill with whitespace to balance columns
               %hyphens,      % allow \url to hyphenate at "-" (hyphens)
               %xetex,        % use XeLaTeX to process the file
               %luatex,       % use LuaLaTeX to process the file
               ]{jacow}
%
% ONLY FOR \footnote in table/tabular
%
\usepackage{pdfpages,multirow,ragged2e} %
%
% CHANGE SEQUENCE OF GRAPHICS EXTENSION TO BE EMBEDDED
% ----------------------------------------------------
% test for XeTeX where the sequence is by default eps-> pdf, jpg, png, pdf, ...
%    and the JACoW template provides JACpic2v3.eps and JACpic2v3.jpg which
%    might generates errors, therefore PNG and JPG first
%
\makeatletter%
	\ifboolexpr{bool{xetex}}
	 {\renewcommand{\Gin@extensions}{.pdf,%
	                    .png,.jpg,.bmp,.pict,.tif,.psd,.mac,.sga,.tga,.gif,%
	                    .eps,.ps,%
	                    }}{}
\makeatother

% CHECK FOR XeTeX/LuaTeX BEFORE DEFINING AN INPUT ENCODING
% --------------------------------------------------------
%   utf8  is default for XeTeX/LuaTeX
%   utf8  in LaTeX only realises a small portion of codes
%
\ifboolexpr{bool{xetex} or bool{luatex}} % test for XeTeX/LuaTeX
 {}                                      % input encoding is utf8 by default
 {\usepackage[utf8]{inputenc}}           % switch to utf8

\usepackage[USenglish]{babel}

\addbibresource{citations.bib}

% Don't justify URLs in the references
\renewcommand*{\bibfont}{\raggedright}
%No hyphenation
\usepackage[none]{hyphenat}

%%
%%   Lengths for the spaces in the title
%%   \setlength\titleblockstartskip{..}  %before title, default 3pt
%%   \setlength\titleblockmiddleskip{..} %between title + author, default 1em
%%   \setlength\titleblockendskip{..}    %afterauthor, default 1em

\begin{document}

\title{A MicroTCA.4  Timing Receiver for the Sirius Timing System}

\author{J.L.N. Brito\thanks{joao.brito@lnls.br}, S.R. Marques, D.O. Tavares, L.M. Russo, G.B.M. Bruno, LNLS, Campinas, Brazil}
	
\maketitle


\begin{abstract}
   The AMC FMC carrier (AFC) is a MicroTCA.4 AMC board which has a very flexible clock circuit that enables any clock source to be connected to any clock input, including telecom clock, FMC clocks, programmable VCXO oscillator and FPGA. This paper presents the use of the AFC board as an event receiver connected to the Sirius timing system to provide low jitter synchronized clocks and triggers for Sirius BPM electronics and other devices.
\end{abstract}


\section{introduction}
Sirius is a 4th  generation  synchrotron light source  based  on  a 5BA magnetic lattice, currently under construction in Brazil by LNLS~\cite{sirius_ipac16}. The machine, designed to achieve a beam emittance of \SI{0.25}{nm$\cdot$rad} and scheduled for commissioning at the end of 2018~\cite{rodrigues2016sirius}, consists of a 150 MeV Linac, a 150 MeV to 3 GeV booster and a 3 GeV storage ring with 518 meters circumference and storage ring with 20 straight sections. Both booster and storage ring RF frequency is \SI{499.658}{MHz} and the Linac will inject in single or multi-bunch mode at \SI{2}{Hz}.

Sirius timing system~\cite{timing_icalepcs15} is a star topology optical fiber network where an event generator (EVG) broadcasts event frames to the event receivers. An event frame decoded by an event receiver can generate clock and trigger signals synchronized to the Sirius RF frequency for the beam injection process and other subsystems such as electron BPMs. The system is composed of Ethernet-configured standalone modules developed by SINAP through a collaboration with LNLS and remotely controlled by an EPICS soft IOC designed by LNLS~\cite{sinap-timing-epics-ioc}.

The Sirius BPM and orbit feedback systems were developed as an open-source hardware platform~\cite{ebpm_icalepcs13} based on MicroTCA.4 crates, AMC and FMC modules, 1 Gigabit Ethernet and PCI Express connectivity. The digital back-end of these systems is the AMC FMC carrier (AFC)~\cite{afc-git}, a MicroTCA.4 AMC board partially based on Simple PCIe FMC carrier (SPEC)~\cite{spec} design. 

Thanks to the flexible clock circuits, trigger and clock distribution options and digital interfaces available in the AFC board and MicroTCA.4 platform, the same hardware platform made it possible to develop an AFC timing receiver board that provides triggers and synchronized clocks for Sirius BPM electronics and other devices. From now on, it shall be referred to as AFC timing. 

\section{hardware}
This section presents the AFC board focusing on timing applications and the interface boards FMC 5 POF and uTCA RTM 8 SFP+.

\subsection{AFC}

The AFC board was specified by LNLS and designed by WUT (Warsaw University of Technology) as a double-width AMC card with 2 fully populated high-pin count FMC mezzanine slots, option for 8 multigigabit links routed to the MicroTCA Rear Transition Module (uRTM) connector, 8 MicroTCA.4 M-LVDS triggers, connectivity to PCIe at Fat Pipe 1 (x4 link), redundant 1 Gb Ethernet ports, full hardware support for the White Rabbit timing system and provision for standalone operation. 

It has a Xilinx Artix-7 200T FFG1156 FPGA and the available clocking resources are: (\textit{I}) a clock switch (Analog Devices ADN4604) allowing routing of MicroTCA.4 low-jitter clocks to any of the FMC slots or AMC connector, (\textit{II}) a 10-280~MHz I$_{2}$C programmable VCXO oscillator (Silicon Labs Si571, 571BJC000121G), (\textit{III}) a 25~MHz VCTCXO (Mercury VM53S3-25.000) connected to a frequency synthesizer (Texas Instruments CDCM61004) fixed configured to 125~MHz, (\textit{IV}) a 20~MHz VCXO (IQD VCXO026156) and (\textit{V}) three DACs (Analog Devices AD5662) to control the oscillators. 

Once inside a MicroTCA crate, an AFC timing should output triggers and a low-jitter synchronized clock through the MicroTCA backplane to the other AFC boards running in the same crate. The low-jitter clock will be used as a reference clock from the ADCs of the BPM electronics.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=0.8\columnwidth]{AFC_POFs_resized}
   \caption{AFC board.}
   \label{fig:afc_pofs}
\end{figure}

\subsection{FMC 5 POF}

The FMC 5 POF \cite{fmc-pof-git} was designed to provide up to 5 plastic optical fiber (POF) IOs, where each POF slot can be manufactured as input or output. Sirius timing system will use these boards with 5 POF outputs to trigger near devices such as power supplies during the booster energy ramp.

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=0.5\columnwidth]{FMC_POF_resized}
   \caption{FMC 5 POF is a FMC board with 5 POF outputs.}
   \label{fig:fmc_pof}
\end{figure}

\subsection{uTCA RTM 8 SFP+}
The uTCA RTM 8 SFP+ \cite{rtm-sfp-git} is a Rear Transition Module board MicroTCA.4 standard. Its main components are 8 SFP+ connectors, which will provide optical fiber interface with timing system, and a general purpose 10-280~MHz I$_{2}$C programmable XO oscillator (Silicon Labs Si570, 570BCC000121G) to output a reference clock to the FPGA GTP transceivers. 

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=0.8\columnwidth]{RTM_SFP_resized}
   \caption{RTM with 8 SFP.}
   \label{fig:rtm_sfp}
\end{figure}

\section{FPGA Gateware}

This section describes the main aspects of the FPGA gateware to implement an event receiver and a frequency and phase locked loop to output a low jitter synchronized reference clock to the ADCs of the BPM electronics.

\subsection{Event Receiver}

An event frame sent from the EVG consists of an 8-bit event code and an 8-bit distributed data bus (DBUS), where each bit of the DBUS maps a sinchronized clock generated by the EVG.
As the EVG is continuously sending event frames at the rate of the event clock, which is $\frac{1}{4}RF=124.9145~MHz$, the AFC timing can monitor a bit of the DBUS or an event code and then output a clock or a trigger, respectively. 

The AFC timing has 18 independently configurable channels, 10 POF outputs from 2 FMC 5 POF boards and 8 AMC configurable as input or output. An AMC channel operating as input can receive a general purpose trigger from another AFC board and, for example, send a corresponding event to the EVG. Once in trigger output mode, each one of these channels can adjust the pulse width and the delay between event receiving and output the trigger with a resolution of one event clock period ($\sim$8~ns), the number of pulses from 1 to 65535 and the pulse polarity level (low to high ou high to low).  

\subsection{Frequency and Phase Locked Loop}
 \textbf{É necessário falar sobre a importância da qualidade deste clock e dizer o quanto ele pode afetar a qualidade da medida dos BPMs}
 
 A frequency and phase locked loop (Fig.~\ref{fig:AFCRefClockLoop}) using the VCXO Si571 was designed to generate a low-jitter synchronized reference clock, which is distributed to the ADCs of the BPM electronics and feedbacked to the FPGA by the ADN4604 clock switch.

From the event clock $f_{evt}$ recovered by the FPGA GTP transceiver, a Mixed-Mode Clock Manager (MMCM) generates the reference clock $f_{ref}$ and the $f_{dmtd}$ clock used by the frequency and phase feedback controller to measure the phase difference between $f_{ref}$ and $f_{out}$.
\[f_{evt} = \frac{1}{4}RF \approx 124.915~MHz\]
\[f_{ref} = \frac{10}{18}f_{evt} = \frac{5}{36}RF \approx 69.397~MHz\]
\[f_{dmtd} = f_{ref}\frac{N}{N+1} \approx 68.918~MHz;~N=144\]

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=0.8\columnwidth]{AFCRefClockLoop}
   \caption{Synchronized reference clock block diagram.}
   \label{fig:AFCRefClockLoop}
\end{figure}

The frequency and phase feedback controller (Fig.~\ref{fig:AFCFPGADMTD}) consists of a frequency detector (FD) and a phase detector (PD) running in two independent feedback loops at the same time to control the VCXO Si571 frequency output. The FD countes the rising edges of the two input clocks during a fixed time window to output a value proportional to the difference of frequency $f_{ref}-f_{out}$. The PD is a digital version of the Dual Mixer Time Difference (DMTD)~\cite{allan1975picosecond}, shown in Figure~\ref{fig:DigitalDMTD}. It outputs a value proportional to the phase difference between $f_{ref}$ and $f_{out}$, $\phi_{ref}-\phi_{out}$. A large difference between $f_{ref}$ and $f_{out}$ turns the PD output negligible and the VCXO is driven by the frequency feedback loop, thereby moving $f_{ref}$ toward $f_{out}$. Thus, the FD output decreases gradually and the frequency feedback loop becomes inactive when $f_{ref}-f_{out}=0$. At the same time, the PD output becomes stable and the phase feedback loop output increases, turning the phase difference $\phi_{ref}-\phi_{out}$ constant.

The frequency feedback loop controls the VCXO frequency via an I$_{2}$C interface, allowing adjusts up to $\pm3500~ppm$ from the center frequency configuration. Its is also the slowest way to do it, however, its not a issue due to the taxa de medição do FD.

The phase feedback loop uses the DAC AD5662 controlled by an SPI interface to tune the VCXO. 

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=0.8\columnwidth]{AFCFPGADMTD}
   \caption{Frequency and phase feedback controller.}
   \label{fig:AFCFPGADMTD}
\end{figure}

\[f_{beat} = f_{ref}-f_{dmtd} = \frac{f_{ref}}{N+1} \approx 478.6~kHz\]
\[\Delta t_{min} = \frac{1}{f_{dmtd}}\frac{f_{beat}}{f_{ref}} = \frac{1}{Nf_{ref}} \approx 100~ps\]

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=0.8\columnwidth]{DigitalDMTD}
   \caption{Digital Dual Mixer Time Difference.}
   \label{fig:DigitalDMTD}
\end{figure}

\begin{figure}[!htb]
   \centering
   \includegraphics*[width=0.8\columnwidth]{AFC_TIMING_SI571}
   \caption{Phase noise.}
   \label{fig:AFCPhaseNoise}
\end{figure}

\section{Software Interface}
The AFC timing receiver will be interfaced with the control system by means of the HALCS framework ~\cite{halcs_pcapac16} ~\cite{halcs_icalepcs17}. It provides a modular approach for abstracting gateware modules as software services that can be exported to a control node and controlled through an RPC API. Because of that approach, all of the already supported gateware modules can be leveraged without extra effort, as the framework will automatically identify known modules and export its functionality.

On top of that, an EPICS IOC with an asyn-based driver was developed to interface with HALCS, mapping the exported RPC API to EPICS PVs and providing access to all of the AFC timing receiver gateware functionalities.

\section{CONCLUSION}

Analyse tests?

\printbibliography
\newpage

\end{document}
